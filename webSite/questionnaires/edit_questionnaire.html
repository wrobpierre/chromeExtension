<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Edit questionnaire</title>
	<style type="text/css">
	.all_questions {
		margin: 0 0 30px 0;
	}

	.error {
		color:red;
	}

	select {
		display: block;
		margin: 20px 0 20px 0;
	}

	div.selector + p {
		display: inline;
	}
</style>
</head>
<body>
	<h1>Edit questionnaire</h1>
	<form action="management_questionnaire.php" method="post">
		<input type="hidden" name="action" value="edit">
		<input type="hidden" name="id_questionnaire">
		<label>Enter the title of your questionnaire&nbsp;:&nbsp;</label><input type="text" name="title"><span class="error"></span>
		<select name="type">
			<option value="article">Article</option>
			<option value="image">Image</option>
		</select>
		<div class="selector">
			<label></label><input type="text" name="data"><span class="error"></span>
		</div>
		<h2>Current questions :</h2>
		<div id="current">
			<div class="all_questions">

			</div>	
		</div>

		<h2>Add questions :</h2><span class="error"></span>
		<div id="new">
			<input type="button" value="add question"><br>
			<div class="all_questions">

			</div>	
		</div>
		<input type="submit" value="send">
	</form>

	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<script type="text/javascript">
		function getUrlParameter(sParam) {
			var sPageURL = decodeURIComponent(window.location.search.substring(1)),
			sURLVariables = sPageURL.split('&'),
			sParameterName,
			i;

			for (i = 0; i < sURLVariables.length; i++) {
				sParameterName = sURLVariables[i].split('=');

				if (sParameterName[0] === sParam) {
					return sParameterName[1] === undefined ? true : sParameterName[1];
				}
			}
		};
		var param = getUrlParameter('id');

		var post = $.post('http://163.172.59.102/webSite/questionnaires/management_questionnaire.php', { action:"get_questions_to_edit", id:param });

		post.done(function(data){
			var dataParse = JSON.parse(data);
			console.log(dataParse);

			$('input[name="id_questionnaire"]').val(dataParse[0]['key_questionnaires']);

			$('input[name="title"]').val(dataParse[0]['title']);

			if (dataParse[0]['type'] == 0) {
				$('select[name="type"]').val('article');
				$('.selector').find('label').text('Link to your Article : ');
				$('input[name="data"]').attr('value', dataParse[0]['link']);
			} 
			else {
				$('select[name="type"]').val('image');
				$('.selector').find('label').text('Link to your Image : ');
				$('input[name="data"]').attr('value', dataParse[0]['link']);
			}

			$.each(dataParse, function(index, value){
				var div = $('<div></div>').attr('class','question');
				var lq = $('<label>Question&nbsp;:&nbsp;</label>');
				var iq = $('<input type="text" name="q['+value['id']+']">').attr('value', value['question']);
				var la = $('<label>Answer&nbsp;(put a list of words separated by a comma without spaces, eg: apple,pear,banana,...):&nbsp;</label>');
				var ia = $('<input type="text" name="a['+value['id']+']">').attr('value', value['answer'].toLowerCase());
				var button = $('<input type="button" value="delete question">');
				button.click(function(){
					var r = confirm('Are you sure you want to delete this question ? It will be permanently deleted.');
					if (r == true) {
						var post = $.post('http://163.172.59.102/webSite/questionnaires/management_questionnaire.php', { action:"delete_question", id:value['id'] });
						$(this).parent().remove();
					}			
				});
				var error = $('<span class="error"></span>');
				div.append(lq,iq,la,ia,button,error,'<hr>');
				$('div#current > div.all_questions').append(div);
			});


			$(document).ready(function(){

				$('select').change(function(){
					if( $('select option:selected').text() == "Article" ) {
						$('.selector').find('label').text('Link to your Article : ');
					}
					else if ( $('select option:selected').text() == "Image" ) {
						$('.selector').find('label').text('Link to your Image : ');
					}
				});

				$('input[value="add question"]').click(function(){
					var div = $('<div></div>').attr('class','question');
					var lq = $('<label>Question&nbsp;:&nbsp;</label>');
					var iq = $('<input type="text" name="nq[]">');
					var la = $('<label>Answer&nbsp;(put a list of words separated by a comma without spaces, eg: apple,pear,banana,...):&nbsp;</label>');
					var ia = $('<input type="text" name="na[]">');
					var button = $('<input type="button" value="delete question">');
					button.click(function(){
						$(this).parent().remove();
					});
					var error = $('<span class="error"></span>');
					div.append(lq,iq,la,ia,button,error,'<hr>');
					$('div#new > div.all_questions').append(div);
				})

				$('form').submit(function(){
					var valid = true;

					if ($('input[name="title"]').val() == "") {
						valid = false;
						$('input[name="title"] + span.error').text(' Missing title');
					}

					if ($('input[name="data"]').val() == "") {
						valid = false;
						$('div.selector span.error').text(' Missing link');
					}

					if($('div#current > div.all_questions').children().length == 0 && $('input[name="nq[]"]').length == 0) {
						valid = false;
						$('p + span.error').text(' Please add at least one question');	
					}

					$('input[name="q[]"]').each(function(){
						if ($(this).val() == "") {
							valid = false;
							$(this).parent().find('span.error').text(" Missing question or missing answer");
						}
					});

					$('input[name="a[]"]').each(function(){
						if ($(this).val() == "") {
							valid = false;
							$(this).parent().find('span.error').text(" Missing question or missing answer");
						}
					});

					$('input[name="nq[]"]').each(function(){
						if ($(this).val() == "") {
							valid = false;
							$(this).parent().find('span.error').text(" Missing question or missing answer");
						}
					});
					
					$('input[name="na[]"]').each(function(){
						if ($(this).val() == "") {
							valid = false;
							$(this).parent().find('span.error').text(" Missing question or missing answer");
						}
					});

					if (!valid) {
						return false;
					}
				});
			});
		});
	</script>
</body>
</html>