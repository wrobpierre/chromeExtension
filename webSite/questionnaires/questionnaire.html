<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" type="text/css" href="../css/questionnaire.css">
	<meta charset="utf-8">
	<title></title>
</head>
<body>
	<header class="parallax-window" data-parallax="scroll" data-image-src="../img/select_question.jpg"></header>
	<div id="form-questionnaire">
		<div id="questionnaire">
			<div id="content">
				
				<h1></h1>


			</div>
		</div>
	</div>
	
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<script type="text/javascript">
		var adress = "http://163.172.59.102"
		//var adress = "http://localhost/chromeExtension"

		function getUrlParameter(sParam) {
			var sPageURL = decodeURIComponent(window.location.search.substring(1)),
			sURLVariables = sPageURL.split('&'),
			sParameterName,
			i;

			for (i = 0; i < sURLVariables.length; i++) {
				sParameterName = sURLVariables[i].split('=');

				if (sParameterName[0] === sParam) {
					return sParameterName[1] === undefined ? true : sParameterName[1];
				}
			}
		};
		var param = getUrlParameter('id');
		
		if (param == undefined) {
			var post = $.post(adress+'/webSite/questionnaires/management_questionnaire.php', { action:"all" });

			post.done(function(data){
				if (data != '') {
					var dataParse = JSON.parse(data);
					console.log(dataParse);
					document.title = 'Questionnaires';
					$('h1').text('List of questionnaires');
					var ul = $('<ul></ul>');
					ul.css("list-style", "none")
					$.each(dataParse, function(index, value){
						var li = $('<li class="list_question"></li>');
						var title = $('<h2></h2>').text(value['title']);
						
						var always_visible = $('<div></div>');
						var do_ques = $('<input type="button" class="button_link" onclick="window:location.href=\''+value['url']+'\'"></input>').attr('value', 'Answer the questionnaire');
						var graph_ques = $('<input type="button" class="button_link" onclick="window:location.href=\''+adress+'/webSite/index.html?id='+value['url'].split('=')[1]+'\'"></input>').attr('value', 'Graph');
						

						var option = $('<div class="option"></div>')
						var edit = $('<input type="button" class="button_link" onclick="window:location.href=\''+adress+'/webSite/questionnaires/edit_questionnaire.html?id='+value['url'].split('=')[1]+'\'"></input>').attr('value', 'Edit');
						var del = $('<button class="button_delete">Delete</button>').click(function(){
							var r = confirm("Are you sure to delete this questionnaire ?");
							if (r == true) {
								var postDel = $.post(adress+'/webSite/questionnaires/management_questionnaire.php', { action:"delete", url:value['url'] });
								postDel.done(function(data){
									alert(data);
									location.reload();
								});
							}
						});
						var edit_result = $('<input type="button" class="button_link" onclick="window:location.href=\''+adress+'/webSite/questionnaires/edit_results.html?id='+value['url'].split('=')[1]+'\'"></input>').attr('value','Edit users\' results');

						always_visible.append(do_ques,graph_ques);
						option.append(edit,del,edit_result);

						li.append(title,always_visible,option);
						ul.append(li);
					})

					var add = $('<input type="button" class="button_link" onclick="window:location.href=\''+adress+'/webSite/questionnaires/add_questionnaire.html\'"></input>').attr('value', 'Add a questionnaire');
					add.css("background-color", "#00B16A");
					add.css("height", "40px");

					$('#content').append(ul,add);
				}
			});
		}
		else {
			//console.log(param);
			var post = $.post(adress+'/webSite/questionnaires/management_questionnaire.php', { action:"get_questions", id:param });

			post.done(function(data){
				var dataParse = JSON.parse(data);
				console.log(dataParse);
				document.title = dataParse[0]['title'];
				$('h1').text(dataParse[0]['title']);
				statement = $('<p></p>').text(dataParse[0]['statement']);
				$('#content').append(statement);

				if (dataParse[0]['link_img'] != "") {
					link = $('<img>').attr('src', dataParse[0]['link_img']).attr('alt', dataParse[0]['link']);
					$('#content').append(link);
				}
				var form = $('<form method="post" action="checkAnswers.php"></form>');
				var user_id = $('<input type="hidden" name="user_id">');
				form.append(user_id);	

				var dataUser = $('<div id="dataUser"></div>');
				var method = $('<input type="hidden" name="method">');

				var button_sign_up = $('<button class="sign_up button">Sign up</button>');
				button_sign_up.prop('disabled',true);
				button_sign_up.click(function(){
					$('div.sign_up').css('display', 'block');
					$('div.sign_in').css('display', 'none');
					$(this).prop('disabled',true);
					$('button.sign_in').prop("disabled",false);
				});

				var button_sign_in = $('<button class="sign_in button">Sign in</button>');
				button_sign_in.click(function(){
					$('div.sign_in').css('display', 'block');
					$('div.sign_up').css('display', 'none');
					$(this).prop('disabled',true);
					$('button.sign_up').prop('disabled',false);
				});

				var sign_up = $('<div class="sign_up"></div>');
				var name = $('<div> <label>Your name :</label> <input class="input_question" type="text" name="name" style="margin:0"> <span class="error"></span> </div>');
				var job = $('<div> <label>Your job/domain :</label> <input class="input_question" type="text" name="job" style="margin:0"> <span class="error"></span> </div>');
				var login = $('<div> <label>Your email :</label> <input class="input_question" type="email" name="login" style="margin:0"> <span class="error"></span> </div>');
				var valid = $('<input class="button" type="button" value="valid">');
				valid.click(function(){
					$('span.error').text('');
					valid = true;

					if ($('input[name="name"]').val() == "") {
						valid = false;
						$('input[name="name"] + span.error').text('missing name');
					}

					if ($('input[name="job"]').val() == "") {
						valid = false;
						$('input[name="job"] + span.error').text('missing job');
					}

					if ($('input[name="login"]').val() == "") {
						valid = false;
						$('input[name="login"] + span.error').text('missing email');
					}
					else {
						var email = $('input[name="login"]').val();
						var post = $.post(adress+'/dataBase.php', { key:'check_user_email', email:email });
						post.done(function(data){
							if (data != 0) {
								valid = false;
								$('input[name="login"] + span.error').text('Already exist');
							} 
							else {
								$('input[name="login"] + span.error').text('');	
								if (valid) {
									$('input[name="method"]').val('sign_up');
									$('div.sign_up > input.button').parent().parent().css('display','none');
									$('div.sign_up > input.button').parent().parent().next().css('display','block');
								}
							}
						});
					}
				});
				sign_up.append(name,job,login,valid);

				var sign_in = $('<div class="sign_in"></div>');
				var register = $('<div> <label>Your email :</label> <input class="input_question" type="email" name="register" style="margin:0"> <span class="error"></span> </div>');
				var valid = $('<input class="button" type="button" value="valid">');
				valid.click(function(){
					if ($('input[name="register"]').val() == "") {
						$('input[name="register"] + span.error').text('missing email');
					}
					else {
						var email = $('input[name="register"]').val();
						var post = $.post(adress+'/dataBase.php', { key:'check_user_email', email:email, method:'sign_in' });
						post.done(function(data){
							var dp = JSON.parse(data);
							if (dp.length == 0) {
								$('input[name="register"] + span.error').text('Doesn\'t exist');
							} 
							else {
								$('input[name="register"] + span.error').text('');
								$('input[name="user_id"]').val(dp[0]['check_id']);

								$('input[name="method"]').val('sign_in');
								$('div.sign_in > input.button').parent().parent().css('display','none');
								$('div.sign_in > input.button').parent().parent().next().css('display','block');
							}
						});
					}
				});
				sign_in.css('display', 'none');
				sign_in.append(register,valid);

				var info = $('<p>*if you wish to have your personal data deleted, contact us at this email address: stageosakadawin@gmail.com</p>')

				dataUser.append(method,button_sign_up,button_sign_in,sign_up,sign_in,info);
				form.append(dataUser);

				for (var i = 0; i < dataParse.length; i++) {
					var div = $('<div class="question" id="'+(i+1)+'"></div>');
					var p = $('<p>'+dataParse[i]['question']+'</p>');
					if (dataParse[i]['type_ques'] == 'text') {
						var input = $('<input class="input_question" type="text" name="q['+dataParse[i]['id']+']">');
						var valid = $('<input class="button" type="button" value="valid">');
						div.append(p,input,valid);
					}
					else if (dataParse[i]['type_ques'] == 'number') {
						var input = $('<input class="input_question" step="any" type="number" name="q['+dataParse[i]['id']+']">');
						if (dataParse[i]['particule'] != '') {
							var particule = $('<label>'+dataParse[i]['particule']+'</label>')
						}
						var valid = $('<input class="button" type="button" value="valid">');
						div.append(p,input,particule,valid);
					}
					else if (dataParse[i]['type_ques'] == 'interval') {
						var input = $('<input class="input_question" step="any" type="number" name="q['+dataParse[i]['id']+']">');
						var valid = $('<input class="button" type="button" value="valid">');
						div.append(p,input,valid);
					}
					else if (dataParse[i]['type_ques'] == 'free') {
						var input = $('<input class="input_question" type="text" name="q['+dataParse[i]['id']+']">');
						var valid = $('<input class="button" type="button" value="valid">');
						div.append(p,input,valid);
					}

					div.css("margin", "5%");
					form.append(div);
				}


				var lastDiv = $('<div></div>')
				var p = $('<p>Don\'t forget to send your questionnaire</p>');
				var submit = $('<input class="button_valid" type="submit" value="send">');
				lastDiv.css("margin", "5%")

				lastDiv.append(p,submit);
				form.append(lastDiv);
				$('#form-questionnaire').css("width","100%");
				$('#content').css("text-align", "center")
				form.css("margin-top","0px");
				//$('#content').append(link);
				$('#content').append(form);

				$(document).ready(function(){

					$('div.question').css('display','none');
					//$('div#dataUser').css('display','none');
					$('form div:last-child').css('display','none');

					$('div.question > input[type="button"]').click(function(){
						$(this).parent().css('display','none');
						$(this).parent().next().css('display','block');
					})

					$('form').submit(function(){

					});
				});
			});
}
</script>
<script src="../js/parallax.js-1.5.0/parallax.js"></script>
</body>
</html>